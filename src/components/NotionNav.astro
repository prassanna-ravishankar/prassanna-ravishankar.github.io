---
// NotionNav.astro - A Notion-style header navigation component for blog posts
---

<div class="notion-nav-container">
  <button 
    class="nav-arrow nav-arrow-left" 
    aria-label="Scroll left"
  >
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
    </svg>
  </button>
  
  <nav class="notion-style-nav">
    <!-- Headings will be added here by the client-side script -->
  </nav>
  
  <button 
    class="nav-arrow nav-arrow-right" 
    aria-label="Scroll right"
  >
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
      <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
    </svg>
  </button>
</div>

<style>
  .notion-nav-container {
    position: sticky;
    top: 80px; /* Account for fixed nav */
    display: flex;
    align-items: center;
    background-color: rgb(var(--color-background) / 0.95);
    border-bottom: 1px solid rgb(var(--color-subtle) / 0.1);
    padding: 12px 0;
    z-index: 40;
    margin-bottom: 32px;
    max-width: 100%;
    backdrop-filter: blur(8px);
  }

  .notion-style-nav {
    display: flex;
    overflow-x: auto;
    white-space: nowrap;
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE and Edge */
    scroll-behavior: smooth;
    padding: 0 10px;
    flex: 1;
  }

  .notion-style-nav::-webkit-scrollbar {
    display: none; /* Chrome, Safari and Opera */
  }

  .nav-arrow {
    background: rgb(var(--color-subtle) / 0.05);
    border: 1px solid rgb(var(--color-subtle) / 0.1);
    color: rgb(var(--color-text-muted));
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 2;
    transition: all 0.2s ease;
    margin: 0 12px;
  }

  .nav-arrow:hover {
    background: rgb(var(--color-subtle) / 0.1);
    color: rgb(var(--color-text-main));
    border-color: rgb(var(--color-primary) / 0.5);
  }

  @media (max-width: 640px) {
    .nav-arrow {
      display: none;
    }
    
    .notion-style-nav {
      padding: 0 15px;
    }
  }
</style>

<script>
  function initNotionNav() {
    // Elements
    const navContainer = document.querySelector('.notion-nav-container');
    const nav = document.querySelector('.notion-style-nav');
    const leftArrow = document.querySelector('.nav-arrow-left');
    const rightArrow = document.querySelector('.nav-arrow-right');
    
    if (!navContainer || !nav || !leftArrow || !rightArrow) return;
    
    // Clear existing nav items to prevent duplicates on soft reload
    nav.innerHTML = '';
    
    // Find all headings from the blog post content - only h2 and h3
    const headingElements = Array.from(document.querySelectorAll('.prose h2, .prose h3'));
    
    if (headingElements.length === 0) {
      // Hide the navigation if there are no headings
      (navContainer as HTMLElement).style.display = 'none';
      return;
    } else {
      (navContainer as HTMLElement).style.display = 'flex';
    }
    
    // Create navigation links
    headingElements.forEach(heading => {
      const link = document.createElement('a');
      link.href = `#${heading.id}`;
      link.textContent = heading.textContent;
      link.dataset.target = heading.id;
      
      // Add class for h3 (subheadings)
      if (heading.tagName.toLowerCase() === 'h3') {
        link.classList.add('subheading');
      }
      
      nav.appendChild(link);
      
      // Add click event
      link.addEventListener('click', (e) => {
        e.preventDefault();
        
        const targetElement = document.getElementById(heading.id);
        if (targetElement) {
          const navHeight = 140; // Approx height of both nav bars
          const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - navHeight;
          
          window.scrollTo({
            top: targetPosition,
            behavior: 'smooth'
          });
          
          // Update URL hash without jumping
          history.pushState(null, null, `#${heading.id}`);
        }
      });
    });
    
    // Arrow click events for scrolling
    leftArrow.addEventListener('click', () => {
      nav.scrollBy({ left: -250, behavior: 'smooth' });
    });
    
    rightArrow.addEventListener('click', () => {
      nav.scrollBy({ left: 250, behavior: 'smooth' });
    });
    
    // Show/hide arrows based on scroll position
    const updateArrows = () => {
      if (nav.scrollLeft <= 10) {
        leftArrow.classList.add('semi-transparent');
      } else {
        leftArrow.classList.remove('semi-transparent');
      }
      
      if (nav.scrollLeft + nav.clientWidth >= nav.scrollWidth - 10) {
        rightArrow.classList.add('semi-transparent');
      } else {
        rightArrow.classList.remove('semi-transparent');
      }
    };
    
    nav.addEventListener('scroll', updateArrows);
    
    // Update active link on scroll
    const updateActiveLink = () => {
      const scrollPosition = window.scrollY + 150; // offset for nav
      
      // Find the current heading based on scroll position
      let currentHeading = null;
      
      for (let i = headingElements.length - 1; i >= 0; i--) {
        const element = headingElements[i] as HTMLElement;
        if (element.offsetTop <= scrollPosition) {
          currentHeading = element;
          break;
        }
      }
      
      // Remove active class from all links
      const links = nav.querySelectorAll('a');
      links.forEach(link => link.classList.remove('active'));
      
      // Add active class to current link
      if (currentHeading) {
        const activeLink = nav.querySelector(`a[data-target="${currentHeading.id}"]`);
        if (activeLink) {
          activeLink.classList.add('active');
          
          // Scroll active link into view if needed
          const navRect = nav.getBoundingClientRect();
          const linkRect = activeLink.getBoundingClientRect();
          
          if (linkRect.left < navRect.left || linkRect.right > navRect.right) {
            activeLink.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
          }
        }
      }
    };
    
    // Initial update and add scroll event listener
    updateActiveLink();
    updateArrows();
    window.addEventListener('scroll', updateActiveLink);
    
    // Check if URL has a hash and scroll to that element
    if (window.location.hash) {
      const targetId = window.location.hash.substring(1);
      const targetElement = document.getElementById(targetId);
      if (targetElement) {
        setTimeout(() => {
          const navHeight = 140;
          const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - navHeight;
          window.scrollTo({
            top: targetPosition,
            behavior: 'smooth'
          });
        }, 300);
      }
    }
    
    // Add dynamic styles that adapt to theme
    const styleId = 'notion-nav-dynamic-styles';
    if (!document.getElementById(styleId)) {
      const style = document.createElement('style');
      style.id = styleId;
      style.textContent = `
        .notion-style-nav a {
          padding: 6px 12px;
          margin-right: 8px;
          color: rgb(var(--color-text-muted));
          font-size: 14px;
          font-weight: 500;
          text-decoration: none;
          border-radius: 6px;
          transition: all 0.2s;
          border: 1px solid transparent;
        }
        
        .notion-style-nav a:hover {
          background: rgb(var(--color-subtle) / 0.05);
          color: rgb(var(--color-text-main));
        }
        
        .notion-style-nav a.active {
          background: rgb(var(--color-primary) / 0.1);
          color: rgb(var(--color-primary));
          border: 1px solid rgb(var(--color-primary) / 0.2);
          font-weight: 600;
        }
        
        .notion-style-nav a.subheading {
          font-size: 13px;
          font-weight: 400;
          padding-left: 20px;
          background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='9 18 15 12 9 6'%3E%3C/polyline%3E%3C/svg%3E");
          background-repeat: no-repeat;
          background-position: 6px center;
          background-size: 10px;
        }

        .dark .notion-style-nav a.subheading {
           background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='9 18 15 12 9 6'%3E%3C/polyline%3E%3C/svg%3E");
        }
        
        .semi-transparent {
          opacity: 0.3;
          pointer-events: none;
        }
      `;
      document.head.appendChild(style);
    }
  }

  // Run on initial page load
  document.addEventListener('DOMContentLoaded', initNotionNav);

  // Run after view transitions (for Astro's View Transitions)
  document.addEventListener('astro:page-load', initNotionNav);
</script>